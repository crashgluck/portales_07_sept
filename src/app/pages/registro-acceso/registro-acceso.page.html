<ion-header>
  <ion-toolbar>
    <ion-title>Registro Acceso</ion-title>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <img slot="end" src="../../../assets/animations/logo/Logo-La-Foresta.webp" style="width: 50px; margin: 10px;">
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-card>
    <ion-card-header>
      <ion-card-title>Registro de Acceso</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <form [formGroup]="form" (ngSubmit)="enviar()">

        <!-- RUT -->
        <ion-item>
          <ion-input
            label="RUT"
            label-placement="stacked"
            placeholder="12345678K"
            formControlName="RUT"
            (ionBlur)="formatearRut()">
          </ion-input>
        </ion-item>
        <ion-note color="danger" *ngIf="form.get('RUT')?.invalid && form.get('RUT')?.touched">
          RUT inválido.
        </ion-note>

        <!-- Búsqueda Parcela -->
        <ion-item>
          <ion-input
            label="Buscar Parcela"
            label-placement="stacked"
            placeholder="Ej: F-06 o nombre propietario"
            [formControl]="busquedaControl">
          </ion-input>
        </ion-item>

        <ion-list *ngIf="parcelasFiltradas.length > 0">
          <ion-item *ngFor="let p of parcelasFiltradas" (click)="seleccionarParcela(p)">
            {{ p.lote }}-{{ p.n_lote }} ({{ p.first_name }})
          </ion-item>
        </ion-list>

        <!-- Patente -->
        <ion-item>
          <ion-input label="Patente" label-placement="stacked" placeholder="Ej: AB1234" formControlName="patente"></ion-input>
        </ion-item>

        <!-- Motivo -->
        <ion-item>
          <ion-select label="Motivo" label-placement="stacked" formControlName="motivo" placeholder="Seleccione">
            <ng-container *ngFor="let grupo of motivosAgrupados">
              <ion-select-option disabled class="grupo-label">{{ grupo.categoria }}</ion-select-option>
              <ion-select-option *ngFor="let item of grupo.opciones" [value]="item.valor">{{ item.texto }}</ion-select-option>
            </ng-container>
          </ion-select>
        </ion-item>

        <!-- Nombre de Empresa -->
        <ion-item *ngIf="mostrarEmpresa">
          <ion-input label="Nombre Empresa" label-placement="stacked" formControlName="nombre_empresa"></ion-input>
        </ion-item>

        <!-- Número y Color Tarjetón -->
        <ion-item *ngIf="form.get('motivo')?.value !== 'PROPIETARIO'">
          <ion-input label="Número Tarjetón" label-placement="stacked" type="number" formControlName="numero_tarjeton"></ion-input>
        </ion-item>

        <ion-item *ngIf="form.get('motivo')?.value !== 'PROPIETARIO'">
          <ion-select label="Color Tarjetón" label-placement="stacked" formControlName="color_tarjeton">
            <ion-select-option value="verde">Verde</ion-select-option>
            <ion-select-option value="rojo">Rojo</ion-select-option>
            <ion-select-option value="amarillo">Amarillo</ion-select-option>
            <ion-select-option value="azul">Azul</ion-select-option>
          </ion-select>
        </ion-item>

        <!-- Fecha y Nota -->
        <ion-item>
          <ion-datetime label="Fecha y Hora" label-placement="stacked" formControlName="fecha_hora" presentation="date-time"></ion-datetime>
        </ion-item>

        <ion-item>
          <ion-textarea label="Nota" label-placement="stacked" formControlName="nota"></ion-textarea>
        </ion-item>

        <!-- Botón -->
        <ion-button expand="full" type="submit" [disabled]="form.invalid">Registrar Acceso</ion-button>
      </form>
    </ion-card-content>
  </ion-card>
</ion-content>
